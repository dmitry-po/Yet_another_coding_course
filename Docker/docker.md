# Docker
## Основные термины
**Container (контейнер)** - изолированная среда с минимально необходимым набором компонентов, выполняющая заданный в образе функционал (иными словами, выполняющийся образ);  
**Image (образ)** - образ базовой операционной системы, код приложения и зависимые библиотеки, скомпонованные в виде единой сущности, на основе которой можно создать контейнер (иными словами, результат сборки Dockerfile);  
**Dockerfile** - набор инструкций для сборки образа;  

**Volumes (тома)** - механизм постоянного хранения данных.

## Настройка контейнера
1. Написать исполняемый код;
2. Настроить файл-конфигуратор образа Dockerfile;
3. Создать образ командой `docker build user/image_name .`;
4. Запустить образ командой `docker run user/image_name`;
5. ...;
6. Profit.
> [**Dockerfile**] ---*build*--> [**Image**] ---*run*--> [**Container**]

## Dockerfile
В файлах Dockerfile содержатся инструкции по созданию образа. Инструкции, при сборке образа, обрабатываются сверху вниз. Пример файла:
``` docker
# Example of Dockerfile
FROM python:3
LABEL maintainer="https://github.com/dmitry-po/"
WORKDIR /usr/src/app
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
VOLUME /logs
COPY . .
EXPOSE 5000
CMD ["python", "./app.py"]
```
### Основные инструкции:
* **FROM** инициирует базовый (родительский) образ. Помимо *python* также часто используются, например, *nginx:alpine*, *ubuntu:18.04*;
* **COPY** копирует данные из указанной папки хоста в указанную папку образа;
* **ADD** копирует файлы и папки (в том числе с удаленного источника), а также распаковывает локальные *.tar файлы;
* **RUN** выполняет заданную команду. В примере выше это установка дополнительных библиотек, также часто используется запись *"RUN apt-get update && apt-get upgrade"* при работе с контейнерами на базе Linux. Выполнение команды создает новый слой.

### Дополнительные инструкции:
* **WORKDIR** устанавливает рабочую директорию для следующей команды (если директории нет, она будет создана);
* **ENV** задает переменные окружения контейнера;
* **CMD** описывает команду с переменными, которую необходимо выполнить после запуска контейнера. Может быть использована только один раз в Dockerfile (если команд несколько, выполняется только последняя);
* **ENTRYPOINT** аналогично CMD задает начальную команду с аргументами, которая выполняется при запуске контейнера. В примере выше можно заменить последнюю строку на *ENTRYPOINT ["python", "./app.py"]*. В отличие от CMD, при запуске контейнера с параметрами командной строки, параметры инструкции ENTRYPOINT не перезаписываются, а дополняются. Общие рекомендации:
  * Если при каждом запуске контейнера необходимо выполнять одну и ту же команду - используется ENTRYPOINT;
  * Если контейнер будет использоваться в качестве приложения - используется ENTRYPOINT;
  * Если при запуске контейнера ему необходимо будет передавать аргументы, которые должны менять аргументы, описанные в Dockerfile - используется CMD.
* **EXPOSE** указывает на необходимость открыть порт. Это только указание, фактическое открытие порта осуществляется при запуске контейнера (параметр *-p*);
* **VOLUME** создает точку монтирования для работы с постоянным хранилищем;
* **LABEL** описывает метаданные о контейнере.

## Полезные команды
`docker build [OPTIONS] PATH | URL | - формирование образа из Dockerfile:
* -t \<name>\<:tag> - присвоение имени и тега (по умолчанию присваивается тег latest);
* -f \<file> - указание пути к файлу Dockerfile (по умолчанию файл ищется в текущей директории).

`docker images [OPTIONS]` - отображение всех доступных образов:
 * -a - вывод всех образов, включая завершенные;
 * -f \<filter expression> - поиск по заданному выражению *filter expression* (например, "status=exited");
 * -q - вывод только id образов.

`docker port CONTAINER` - выводит список открытых портов контейнера *CONTAINER*.

`docker ps [OPTIONS]` - отображение контейнеров (параметры аналогичны команде images).

`docker rm CONTAINER [CONTAINER...]` - удаление контейнера (или нескольких через пробел).

`docker rmi IMAGE [IMAGE...]` - удаление образов.

`docker run [OPTIONS] IMAGE [COMMAND] [ARG...]` - запуск контейнера с образом *IMAGE* с последующим исполнением команды *COMMAND* с аргументами *ARG*. Часто используемые параметры:
 * -d - открепляет контейнер от консоли;
 * -it - запускает контейнер в итеративном режиме (с выводом результатов в консоль);  
 * -name \<name> - позволяет задать имя контейнера;
 * -P - делает все порты открытыми и случайными;
 * -p \<host-port>:\<docker-port> - открывает указанный порт (например, 8888:80 будет перенаправлять данные с порта 80 контейнера на порт 8888 хоста);
 * --rm - удаляет контейнер при завершении.

 `docker stop CONTAINER` - останавливает контейнер c указанным идентификатором.  

## Источники
1. [Полное практическое руководство по Docker: с нуля до кластера на AWS](https://habr.com/ru/post/310460/);
2. [Настройка Dockerfile для Python](https://hub.docker.com/_/python/);
3. [Цикл статей "Изучаем Docker"](https://habr.com/ru/company/ruvds/blog/438796/).